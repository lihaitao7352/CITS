WITH FilteredPPJD AS (
    SELECT
        PPJD.*,
        ROW_NUMBER() OVER (PARTITION BY PPJD.PPJD_PJ_COD ORDER BY PPJD.PPJD_KM_COD) AS rn
    FROM
        BGTA3_PPJD PPJD
)
SELECT
    FPJD.PPJD_KHA_COD AS 会社コード,
    FPJD.PPJD_SZK_COD AS 所属コード,
    FPJD.PPJD_PJ_COD AS プロジェクトコード,
    FPJD.PPJD_KM_COD AS 件名コード,
    FPJD.PPJD_GMS_COD AS 業務種別コード,
    FPJD.PPJD_CKS_YMD AS 着手日,
    FPJD.PPJD_KRY_YMD AS 完了日
FROM
    FilteredPPJD FPJD
JOIN
    BGTA2_SKMD SKMD ON FPJD.PPJD_KM_COD = SKMD.SKMD_KM_COD
    AND SKMD.SKMD_KBS_VER_ID = (
        SELECT MAX(SKMD_KBS_VER_ID)
        FROM BGTA2_SKMD
        WHERE SKMD.SKMD_KHA_COD = FPJD.PPJD_KHA_COD
          AND SKMD.SKMD_KM_COD = FPJD.PPJD_KM_COD
    )
WHERE
    FPJD.rn = 1
    AND FPJD.PPJD_GMS_COD <> SKMD.SKMD_GMS_COD
ORDER BY
    FPJD.PPJD_KHA_COD,
    FPJD.PPJD_SZK_COD,
    FPJD.PPJD_PJ_COD,
    FPJD.PPJD_KM_COD;
